name: Publish

on:
  workflow_dispatch:
    inputs:
      publishToNuGet:
        description: "Publish to NuGet.org (PowerShell Gallery uses same feed)"
        required: false
        default: "true"
      publishToGitHub:
        description: "Publish to GitHub Packages"
        required: false
        default: "true"
      versionOverride:
        description: "Override module version (optional)"
        required: false
        default: ""
      createRelease:
        description: "Create GitHub Release"
        required: false
        default: "true"
  release:
    types: [published]
  workflow_call:
    secrets:
      PSGALLERY_API_KEY:
        required: false
      NUGET_API_KEY:
        required: false
      PACKAGES_TOKEN:
        required: false
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed
    branches:
      - main

permissions:
  contents: write

jobs:
  validate:
    name: Validate module
    runs-on: windows-latest
    outputs:
      version: ${{ steps.manifest.outputs.version }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Install quality tools
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          if (-not (Get-Module -ListAvailable -Name Pester)) {
              Install-Module -Name Pester -MinimumVersion 5.4.0 -Force -SkipPublisherCheck
          }
          if (-not (Get-Module -ListAvailable -Name PSScriptAnalyzer)) {
              Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck
          }
        shell: pwsh

      - name: Run Script Analyzer
        run: |
          Import-Module PSScriptAnalyzer
          $results = Invoke-ScriptAnalyzer -Path ./ColorScripts-Enhanced -Recurse -Settings ./PSScriptAnalyzerSettings.psd1 -Severity 'Error','Warning' -ReportSummary
          if ($results) {
              $results | Format-Table -AutoSize
              throw 'ScriptAnalyzer reported findings.'
          }
        shell: pwsh

      - name: Run Pester tests
        run: |
          Import-Module Pester
          $configuration = New-PesterConfiguration
          $configuration.Run.Path = './Tests'
          $configuration.Output.Verbosity = 'Detailed'
          Invoke-Pester -Configuration $configuration
        shell: pwsh

      - name: Verify manifest version
        id: manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path ./ColorScripts-Enhanced/ColorScripts-Enhanced.psd1
          $version = if ([string]::IsNullOrWhiteSpace('${{ github.event.inputs.versionOverride }}')) {
              $manifest.Version.ToString()
          } else {
              '${{ github.event.inputs.versionOverride }}'
          }

          Write-Host "Module version: $version"
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

          if ('${{ github.event_name }}' -eq 'release') {
              $tag = '${{ github.event.release.tag_name }}'.TrimStart('v')
              if ($tag -ne $version) {
                  throw "Release tag $tag does not match module version $version"
              }
          }

      - name: Upload module artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: module-source
          path: ColorScripts-Enhanced/

  create-release:
    name: Create GitHub Release
    needs: validate
    if: |
      needs.validate.result == 'success' &&
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.createRelease == 'true' || github.event.inputs.createRelease == '')
    runs-on: ubuntu-latest
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Create Release
        uses: ncipollo/release-action@2c591bcc8ecdcd2db72b97d6147f871fcd833ba5 # v1.14.0
        with:
          tag: v${{ needs.validate.outputs.version }}
          name: Release v${{ needs.validate.outputs.version }}
          draft: false
          prerelease: false
          generateReleaseNotes: true
          skipIfReleaseExists: true

  publish:
    name: Publish
    needs: validate
    if: |
      needs.validate.result == 'success' &&
      (github.event_name == 'workflow_dispatch' ||
       github.event_name == 'release' ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))
    runs-on: windows-latest
    env:
      PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
      PACKAGES_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
      PUBLISH_TO_NUGET_INPUT: ${{ github.event.inputs.publishToNuGet }}
      PUBLISH_TO_GITHUB_INPUT: ${{ github.event.inputs.publishToGitHub }}
      MODULE_VERSION: ${{ needs.validate.outputs.version }}
    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Package module
        id: package
        run: |
          Import-Module PowerShellGet -ErrorAction Stop

          $stagingPath = Join-Path $env:RUNNER_TEMP "module-packages"
          if (Test-Path $stagingPath) {
              Remove-Item -Path $stagingPath -Recurse -Force
          }
          New-Item -ItemType Directory -Path $stagingPath | Out-Null

          $repoName = 'LocalModuleStaging'
          if (Get-PSRepository -Name $repoName -ErrorAction SilentlyContinue) {
              Unregister-PSRepository -Name $repoName -ErrorAction SilentlyContinue
          }

          Register-PSRepository -Name $repoName -SourceLocation $stagingPath -PublishLocation $stagingPath -InstallationPolicy Trusted

          try {
              Publish-Module -Path ./ColorScripts-Enhanced -Repository $repoName -NuGetApiKey 'LocalRepositoryKey' -ErrorAction Stop | Out-Null
          }
          finally {
              Unregister-PSRepository -Name $repoName -ErrorAction SilentlyContinue
          }

          $package = Get-ChildItem -Path $stagingPath -Filter '*.nupkg' | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if (-not $package) {
              throw 'Failed to produce NuGet package for the module.'
          }

          "packagePath=$($package.FullName)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          "packageName=$($package.Name)" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Packaged module to: $($package.FullName)"
        shell: pwsh

      - name: Publish to PowerShell Gallery
        if: ${{ env.PSGALLERY_API_KEY != '' && (github.event_name != 'workflow_dispatch' || env.PUBLISH_TO_NUGET_INPUT != 'false') }}
        run: |
          $packagePath = '${{ steps.package.outputs.packagePath }}'
          if (-not (Test-Path $packagePath)) {
              throw "Package not found at $packagePath"
          }

          $apiKey = $env:PSGALLERY_API_KEY
          if ([string]::IsNullOrWhiteSpace($apiKey)) {
              Write-Host 'No PowerShell Gallery API key provided. Skipping publish.'
              return
          }

          Write-Host "Publishing $packagePath to PowerShell Gallery"
          dotnet nuget push $packagePath --api-key $apiKey --source https://www.powershellgallery.com/api/v2/package --skip-duplicate
        shell: pwsh

      - name: Publish to NuGet.org
        if: ${{ env.NUGET_API_KEY != '' && (github.event_name != 'workflow_dispatch' || env.PUBLISH_TO_NUGET_INPUT != 'false') }}
        run: |
          $packagePath = '${{ steps.package.outputs.packagePath }}'
          if (-not (Test-Path $packagePath)) {
              throw "Package not found at $packagePath"
          }

          $apiKey = $env:NUGET_API_KEY
          if ([string]::IsNullOrWhiteSpace($apiKey)) {
              Write-Host 'No NuGet.org API key provided. Skipping publish.'
              return
          }

          Write-Host "Publishing $packagePath to NuGet.org"
          dotnet nuget push $packagePath --api-key $apiKey --source https://api.nuget.org/v3/index.json --skip-duplicate
        shell: pwsh

      - name: Publish to GitHub Packages
        if: ${{ env.PACKAGES_TOKEN != '' && (github.event_name != 'workflow_dispatch' || env.PUBLISH_TO_GITHUB_INPUT != 'false') }}
        run: |
          $packagePath = '${{ steps.package.outputs.packagePath }}'
          if (-not (Test-Path $packagePath)) {
              throw "Package not found at $packagePath"
          }

          $token = $env:PACKAGES_TOKEN
          if ([string]::IsNullOrWhiteSpace($token)) {
              Write-Host 'No GitHub Packages token provided. Skipping publish.'
              return
          }

          $source = "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
          Write-Host "Publishing $packagePath to GitHub Packages feed $source"
          dotnet nuget push $packagePath --api-key $token --source $source --skip-duplicate
        shell: pwsh
