# Codecov configuration for ps-color-scripts-enhanced
# See: https://docs.codecov.com/docs/codecov-yaml
# Optimized for PowerShell module architecture
# Updated for 2025 Codecov best practices
# yaml-language-server: $schema=https://www.schemastore.org/codecov.json
codecov:
    archive:
        uploads: true # Keep historical data for analytics

    branch: main
    max_report_age: off # Disable age check to prevent CI timing issues
    notify:
        manual_trigger: false # Explicit setting for modern CI/CD pipelines
        notify_error: true # Show upload failures in comments
        wait_for_ci: true
    require_ci_to_pass: true

comment:
    behavior: default
    hide_project_coverage: false

    layout: "header, flags, diff, tree, files, reach, betaprofiling, components,
        footer, feedback"
    require_base: false # Allow comments on first PR
    require_changes: false
    require_head: false # Require head report to comment

component_management:
    default_rules:
        statuses:
            - branches:
                  - "!main"
              target: auto
              threshold: 2%
              type: project
    individual_components:
        # === CORE MODULE (Highest Coverage Requirements) ===
        - component_id: core_module
          name: "Core Module"
          paths:
              - ColorScripts-Enhanced/**
          statuses:
              - target: 95%
                threshold: 1%
                type: project
              - target: 90%
                threshold: 3%
                type: patch
        # === TEST SUITE (High Coverage - Test Code) ===
        - component_id: test_suite
          name: "Test Suite"
          paths:
              - Tests/**
          statuses:
              - target: 90%
                threshold: 2%
                type: project
              - target: 85%
                threshold: 5%
                type: patch
        # === UTILITY SCRIPTS (Medium Coverage) ===
        - component_id: utility_scripts
          name: "Utility Scripts"
          paths:
              - scripts/**
          statuses:
              - target: 80%
                threshold: 3%
                type: project
              - target: 75%
                threshold: 7%
                type: patch
        # === CONFIGURATION AND BUILD (Lower Coverage) ===
        - component_id: configuration
          name: "Configuration & Build"
          paths:
              - package.json
          statuses:
              - target: 60%
                threshold: 5%
                type: project
              - target: 50%
                threshold: 10%
                type: patch

coverage:
    ignore:
        # Build outputs and generated files
        - "dist/**/*"
        - "**/dist/**/*"
        - "coverage/**/*"
        - "release/**/*"

        # Development and configuration files
        - "docs/**/*"
        - "**/*.md"
        - "**/*.yml"
        - "**/*.yaml"
        - "**/*.json"
        - "**/*.toml"
        - "**/*.psd1" # Module manifest, low coverage
        - "package.json"
        - "package-lock.json"
        - "yarn.lock"
        - "pnpm-lock.yaml"

        # Test files (excluded to avoid counting coverage for the tests themselves)
        - "Tests/**/*"

        # Script automation and tooling (excluded from totals)
        - "scripts/**/*"
        - "ColorScripts-Enhanced/Scripts/**/*"

        # Static assets
        - "assets/**/*"
        - "**/*.ans" # ANSI files
        - "**/*.txt" # Text files

        # Node modules and dependencies
        - "node_modules/**/*"

        # Generated or third-party
        - "types/**/*" # Type definitions

    precision: 2
    range: "60...100" # Realistic range for PowerShell module

    round: down
    status:
        patch:
            default:
                only_pulls: false
                base: auto
                target: 70% # Realistic for new code in PowerShell
                threshold: 10%
            module:
                flags:
                    - module
                paths:
                    - "ColorScripts-Enhanced/"
                target: 95%
                threshold: 10%
            tests:
                flags:
                    - tests
                paths:
                    - "Tests/"
                target: 80%
                threshold: 10%
        project:
            default:
                base: auto
                if_ci_failed: error
                only_pulls: false
                target: auto
                threshold: 2%
            module:
                flags:
                    - module
                paths:
                    - "ColorScripts-Enhanced/"
                target: 95% # High target for core module
                threshold: 2%
            tests:
                flags:
                    - tests
                paths:
                    - "Tests/"
                target: 95%
                threshold: 3%

flags:
    module:
        carryforward: true
        ignore:
            - "Tests/**/*" # Don't include tests in module coverage
            - "scripts/**/*"
            - "docs/**/*"
        paths:
            - ColorScripts-Enhanced/
    tests:
        carryforward: true
        ignore:
            - "ColorScripts-Enhanced/**/*" # Don't include module in test coverage
        paths:
            - Tests/

# Modern GitHub integration
github_checks:
    annotations: true

parsers:
    jacoco:
        partials_as_hits: false # More accurate for PowerShell command coverage
    cobertura:
        handle_missing_conditions: true
        partials_as_hits: false
    gcov:
        branch_detection:
            conditional: true
            loop: true
            macro: false
            method: false
    javascript:
        enable_partials: true
    v1:
        include_full_missed_files: true

# Modern Slack integration
slack_app: false # Set to true to enable Codecov Slack App notifications
